#!/bin/bash
set -e

echo '=== Updating auto-shutdown script ==='

# Stop the service
echo 'Stopping minecraft-autoshutdown service...'
systemctl stop minecraft-autoshutdown.service

# Backup old script
echo 'Backing up old script...'
cp /usr/local/bin/minecraft-autoshutdown.sh /usr/local/bin/minecraft-autoshutdown.sh.backup.\

# Decode and write new script
echo 'Writing new script...'
echo 'IyEvYmluL2Jhc2gKCiMgQXV0by1zaHV0ZG93biBzY3JpcHQgZm9yIE1pbmVjcmFmdCBzZXJ2ZXIKIyBTdG9wcyBzZXJ2ZXIgYWZ0ZXIgMTUgbWludXRlcyBvZiBubyBwbGF5ZXJzCgpMT0dfRklMRT0iL3Zhci9sb2cvbWluZWNyYWZ0LWF1dG9zaHV0ZG93bi5sb2ciCk1JTkVDUkFGVF9MT0c9Ii9taW5lY3JhZnQvc2VydmVyL2xvZ3MvbGF0ZXN0LmxvZyIKQ0hFQ0tfSU5URVJWQUw9NjAgICMgQ2hlY2sgZXZlcnkgMSBtaW51dGUKRElTQ09SRF9XRUJIT09LX1VSTD0iJHtESVNDT1JEX1dFQkhPT0tfVVJMOi19IgoKIyBHZXQgaW5zdGFuY2UgbWV0YWRhdGEgKG9uY2UgYXQgc3RhcnR1cCkKSU5TVEFOQ0VfSUQ9JChlYzItbWV0YWRhdGEgLS1pbnN0YW5jZS1pZCB8IGN1dCAtZCAiICIgLWYgMikKUkVHSU9OPSQoZWMyLW1ldGFkYXRhIC0tYXZhaWxhYmlsaXR5LXpvbmUgfCBjdXQgLWQgIiAiIC1mIDIgfCBzZWQgJ3MvW2Etel0kLy8nKQoKIyBGdW5jdGlvbiB0byBnZXQgSURMRV9USU1FIGZyb20gU1NNIFBhcmFtZXRlciBTdG9yZQpnZXRfaWRsZV90aW1lKCkgewogICAgbG9jYWwgaWRsZV90aW1lPSQoYXdzIHNzbSBnZXQtcGFyYW1ldGVyIC0tbmFtZSAiL21pbmVjcmFmdC8ke0lOU1RBTkNFX0lEfS9pZGxlX3RpbWUiIC0tcmVnaW9uICIkUkVHSU9OIiAtLXF1ZXJ5ICdQYXJhbWV0ZXIuVmFsdWUnIC0tb3V0cHV0IHRleHQgMj4vZGV2L251bGwgfHwgZWNobyAiOTAwIikKICAgIAogICAgIyBWYWxpZGF0ZSBJRExFX1RJTUUgaXMgYSBudW1iZXIKICAgIGlmICEgW1sgIiRpZGxlX3RpbWUiID1+IF5bMC05XSskIF1dOyB0aGVuCiAgICAgICAgaWRsZV90aW1lPTkwMAogICAgZmkKICAgIAogICAgZWNobyAiJGlkbGVfdGltZSIKfQoKIyBJbml0aWFsIElETEVfVElNRQpJRExFX1RJTUU9JChnZXRfaWRsZV90aW1lKQpMQVNUX0NPTkZJR19DSEVDSz0wCkNPTkZJR19DSEVDS19JTlRFUlZBTD0zMDAgICMgQ2hlY2sgZm9yIGNvbmZpZyBjaGFuZ2VzIGV2ZXJ5IDUgbWludXRlcyAoMzAwIHNlY29uZHMpCgojIFBsYXllciB0cmFja2luZyB1c2luZyBhc3NvY2lhdGl2ZSBhcnJheSAoYmFzaCA0LjArKQpkZWNsYXJlIC1BIHBsYXllcnMKCmxvZ19tZXNzYWdlKCkgewogICAgZWNobyAiWyQoZGF0ZSAnKyVZLSVtLSVkICVIOiVNOiVTJyldICQxIiA+PiAiJExPR19GSUxFIgp9CgojIFNlbmQgRGlzY29yZCBub3RpZmljYXRpb24Kc2VuZF9kaXNjb3JkX25vdGlmaWNhdGlvbigpIHsKICAgIGxvY2FsIG1lc3NhZ2U9IiQxIgogICAgCiAgICBpZiBbIC16ICIkRElTQ09SRF9XRUJIT09LX1VSTCIgXTsgdGhlbgogICAgICAgIGxvZ19tZXNzYWdlICJEaXNjb3JkIHdlYmhvb2sgbm90IGNvbmZpZ3VyZWQsIHNraXBwaW5nIG5vdGlmaWNhdGlvbiIKICAgICAgICByZXR1cm4KICAgIGZpCiAgICAKICAgIGxvY2FsIGpzb25fcGF5bG9hZD0kKGNhdCA8PEVPRgp7CiAgImNvbnRlbnQiOiAiJG1lc3NhZ2UiCn0KRU9GCikKICAgIAogICAgY3VybCAtSCAiQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uIiBcCiAgICAgICAgIC1YIFBPU1QgXAogICAgICAgICAtZCAiJGpzb25fcGF5bG9hZCIgXAogICAgICAgICAiJERJU0NPUkRfV0VCSE9PS19VUkwiIDI+JjEgfCB0ZWUgLWEgIiRMT0dfRklMRSIKfQoKIyBVcGRhdGUgcGxheWVyIHN0YXR1cyBmcm9tIGxvZwp1cGRhdGVfcGxheWVyX3N0YXR1cygpIHsKICAgIGlmIFsgISAtZiAiJE1JTkVDUkFGVF9MT0ciIF07IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCiAgICAKICAgICMgUHJvY2VzcyByZWNlbnQgam9pbi9sZWZ0IGV2ZW50cwogICAgd2hpbGUgSUZTPSByZWFkIC1yIGxpbmU7IGRvCiAgICAgICAgIyAiUGxheWVyTmFtZSBqb2luZWQgdGhlIGdhbWUiIHBhdHRlcm4KICAgICAgICBpZiBbWyAiJGxpbmUiID1+IFxdOlwgKFteXCBdKylcIGpvaW5lZFwgdGhlXCBnYW1lIF1dOyB0aGVuCiAgICAgICAgICAgIHBsYXllcj0iJHtCQVNIX1JFTUFUQ0hbMV19IgogICAgICAgICAgICBwbGF5ZXJzWyIkcGxheWVyIl09MQogICAgICAgICAgICBsb2dfbWVzc2FnZSAiUGxheWVyIGpvaW5lZDogJHBsYXllciIKICAgICAgICBmaQogICAgICAgIAogICAgICAgICMgIlBsYXllck5hbWUgbGVmdCB0aGUgZ2FtZSIgcGF0dGVybgogICAgICAgIGlmIFtbICIkbGluZSIgPX4gXF06XCAoW15cIF0rKVwgbGVmdFwgdGhlXCBnYW1lIF1dOyB0aGVuCiAgICAgICAgICAgIHBsYXllcj0iJHtCQVNIX1JFTUFUQ0hbMV19IgogICAgICAgICAgICB1bnNldCBwbGF5ZXJzWyIkcGxheWVyIl0KICAgICAgICAgICAgbG9nX21lc3NhZ2UgIlBsYXllciBsZWZ0OiAkcGxheWVyIgogICAgICAgIGZpCiAgICBkb25lIDwgPCh0YWlsIC1uIDUwMCAiJE1JTkVDUkFGVF9MT0ciIHwgZ3JlcCAtRSAiKGpvaW5lZCB0aGUgZ2FtZXxsZWZ0IHRoZSBnYW1lKSIpCn0KCiMgR2V0IGN1cnJlbnQgcGxheWVyIGNvdW50CmdldF9wbGF5ZXJfY291bnQoKSB7CiAgICBlY2hvICIkeyNwbGF5ZXJzW0BdfSIKfQoKIyBHZXQgY3VycmVudCBwbGF5ZXIgbGlzdApnZXRfcGxheWVyX2xpc3QoKSB7CiAgICBpZiBbICIkeyNwbGF5ZXJzW0BdfSIgLWVxIDAgXTsgdGhlbgogICAgICAgIGVjaG8gIm5vbmUiCiAgICBlbHNlCiAgICAgICAgZWNobyAiJHshcGxheWVyc1tAXX0iCiAgICBmaQp9CgppZGxlX3NlY29uZHM9MApsYXN0X3BsYXllcl9jb3VudD0wCgpsb2dfbWVzc2FnZSAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmxvZ19tZXNzYWdlICJBdXRvLXNodXRkb3duIG1vbml0b3Igc3RhcnRlZCAoaW1wcm92ZWQgdmVyc2lvbikiCmxvZ19tZXNzYWdlICJTZXJ2ZXIgd2lsbCBzdG9wIGFmdGVyICR7SURMRV9USU1FfSBzZWNvbmRzICgkKCgkSURMRV9USU1FIC8gNjApKSBtaW51dGVzKSBvZiBubyBwbGF5ZXJzIgpsb2dfbWVzc2FnZSAiSW5zdGFuY2UgSUQ6ICRJTlNUQU5DRV9JRCwgUmVnaW9uOiAkUkVHSU9OIgpsb2dfbWVzc2FnZSAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCgp3aGlsZSB0cnVlOyBkbwogICAgIyBQZXJpb2RpY2FsbHkgY2hlY2sgZm9yIGNvbmZpZyBjaGFuZ2VzIChldmVyeSA1IG1pbnV0ZXMpCiAgICBjdXJyZW50X3RpbWU9JChkYXRlICslcykKICAgIGlmIFsgJCgoY3VycmVudF90aW1lIC0gTEFTVF9DT05GSUdfQ0hFQ0spKSAtZ2UgJENPTkZJR19DSEVDS19JTlRFUlZBTCBdOyB0aGVuCiAgICAgICAgTkVXX0lETEVfVElNRT0kKGdldF9pZGxlX3RpbWUpCiAgICAgICAgaWYgWyAiJE5FV19JRExFX1RJTUUiIC1uZSAiJElETEVfVElNRSIgXTsgdGhlbgogICAgICAgICAgICBsb2dfbWVzc2FnZSAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCiAgICAgICAgICAgIGxvZ19tZXNzYWdlICJDb25maWcgY2hhbmdlIGRldGVjdGVkOiBJRExFX1RJTUUgY2hhbmdlZCBmcm9tICR7SURMRV9USU1FfXMgKCQoKCRJRExFX1RJTUUgLyA2MCkpbWluKSB0byAke05FV19JRExFX1RJTUV9cyAoJCgoJE5FV19JRExFX1RJTUUgLyA2MCkpbWluKSIKICAgICAgICAgICAgbG9nX21lc3NhZ2UgIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgogICAgICAgICAgICBJRExFX1RJTUU9JE5FV19JRExFX1RJTUUKICAgICAgICAgICAgIyBSZXNldCBpZGxlIGNvdW50ZXIgdG8gYXBwbHkgbmV3IHRpbWVvdXQKICAgICAgICAgICAgaWRsZV9zZWNvbmRzPTAKICAgICAgICBmaQogICAgICAgIExBU1RfQ09ORklHX0NIRUNLPSRjdXJyZW50X3RpbWUKICAgIGZpCiAgICAKICAgICMgVXBkYXRlIHBsYXllciBzdGF0dXMKICAgIHVwZGF0ZV9wbGF5ZXJfc3RhdHVzCiAgICAKICAgIHBsYXllcl9jb3VudD0kKGdldF9wbGF5ZXJfY291bnQpCiAgICAKICAgICMgTG9nIHdoZW4gcGxheWVyIGNvdW50IGNoYW5nZXMKICAgIGlmIFsgIiRwbGF5ZXJfY291bnQiIC1uZSAiJGxhc3RfcGxheWVyX2NvdW50IiBdOyB0aGVuCiAgICAgICAgcGxheWVyX2xpc3Q9JChnZXRfcGxheWVyX2xpc3QpCiAgICAgICAgbG9nX21lc3NhZ2UgIlBsYXllciBjb3VudCBjaGFuZ2VkOiAkbGFzdF9wbGF5ZXJfY291bnQgLT4gJHBsYXllcl9jb3VudCAoY3VycmVudDogJHBsYXllcl9saXN0KSIKICAgICAgICBsYXN0X3BsYXllcl9jb3VudD0kcGxheWVyX2NvdW50CiAgICBmaQogICAgCiAgICBpZiBbICIkcGxheWVyX2NvdW50IiAtZXEgMCBdOyB0aGVuCiAgICAgICAgaWRsZV9zZWNvbmRzPSQoKGlkbGVfc2Vjb25kcyArIENIRUNLX0lOVEVSVkFMKSkKICAgICAgICAKICAgICAgICAjIExvZyBzdGF0dXMgZXZlcnkgNSBtaW51dGVzCiAgICAgICAgaWYgWyAkKChpZGxlX3NlY29uZHMgJSAzMDApKSAtZXEgMCBdOyB0aGVuCiAgICAgICAgICAgIHJlbWFpbmluZz0kKChJRExFX1RJTUUgLSBpZGxlX3NlY29uZHMpKQogICAgICAgICAgICBsb2dfbWVzc2FnZSAiTm8gcGxheWVycyBmb3IgJHtpZGxlX3NlY29uZHN9cyAoc3RvcHBpbmcgaW4gJHtyZW1haW5pbmd9cykiCiAgICAgICAgZmkKICAgICAgICAKICAgICAgICBpZiBbICIkaWRsZV9zZWNvbmRzIiAtZ2UgIiRJRExFX1RJTUUiIF07IHRoZW4KICAgICAgICAgICAgbG9nX21lc3NhZ2UgIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgogICAgICAgICAgICBsb2dfbWVzc2FnZSAiU3RvcHBpbmcgc2VydmVyIGFmdGVyICR7SURMRV9USU1FfSBzZWNvbmRzIG9mIG5vIHBsYXllcnMiCiAgICAgICAgICAgIGxvZ19tZXNzYWdlICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2VuZCBEaXNjb3JkIG5vdGlmaWNhdGlvbiB2aWEgTGFtYmRhCiAgICAgICAgICAgIGN1cnJlbnRfdGltZT0kKGRhdGUgJyslWS0lbS0lZCAlSDolTTolUycpCiAgICAgICAgICAgIG1lc3NhZ2U9Iu6BnuWwhSAqKk1pbmVjcmFmdOe5p++9tee5ne+9vOe5neiIjOODu+e4uueRmuODu+icjeWLn+KXj+ixge+9oue4uuWKseKIque4uuWKseKXhioqXG5cbumAheODu+e9sDog57md5Yqxzp7nuafvvaTnuZ3vvaTnuZ3vvbzojbPmpormg6AkKCgkSURMRV9USU1FIC8gNjApKeibu+ODu++9teeigeKEg1xu6Jub5oeI772t772i6K2O44KH57a+OiAkY3VycmVudF90aW1lIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBVUkwgZW5jb2RlIHRoZSBtZXNzYWdlCiAgICAgICAgICAgIGVuY29kZWRfbWVzc2FnZT0kKGVjaG8gLW4gIiRtZXNzYWdlIiB8IGpxIC1zUnIgQHVyaSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2FsbCBMYW1iZGEgZnVuY3Rpb24gdmlhIEFQSSBHYXRld2F5CiAgICAgICAgICAgIFJFR0lPTj0kKGVjMi1tZXRhZGF0YSAtLWF2YWlsYWJpbGl0eS16b25lIHwgY3V0IC1kICIgIiAtZiAyIHwgc2VkICdzL1thLXpdJC8vJykKICAgICAgICAgICAgTk9USUZZX1VSTD0iaHR0cHM6Ly9tZjcxaDZhNWY5LmV4ZWN1dGUtYXBpLiR7UkVHSU9OfS5hbWF6b25hd3MuY29tL3Byb2Qvbm90aWZ5P21lc3NhZ2U9JHtlbmNvZGVkX21lc3NhZ2V9JmNoYW5uZWw9c3RhdHVzIgogICAgICAgICAgICAKICAgICAgICAgICAgY3VybCAtcyAiJE5PVElGWV9VUkwiIHx8IGxvZ19tZXNzYWdlICJGYWlsZWQgdG8gc2VuZCBEaXNjb3JkIG5vdGlmaWNhdGlvbiIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3RvcCBNaW5lY3JhZnQgc2VydmVyCiAgICAgICAgICAgIHN5c3RlbWN0bCBzdG9wIG1pbmVjcmFmdC5zZXJ2aWNlCiAgICAgICAgICAgIHNsZWVwIDUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3RvcCBFQzIgaW5zdGFuY2UKICAgICAgICAgICAgSU5TVEFOQ0VfSUQ9JChlYzItbWV0YWRhdGEgLS1pbnN0YW5jZS1pZCB8IGN1dCAtZCAiICIgLWYgMikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ19tZXNzYWdlICJTdG9wcGluZyBFQzIgaW5zdGFuY2U6ICRJTlNUQU5DRV9JRCAocmVnaW9uOiAkUkVHSU9OKSIKICAgICAgICAgICAgYXdzIGVjMiBzdG9wLWluc3RhbmNlcyAtLWluc3RhbmNlLWlkcyAiJElOU1RBTkNFX0lEIiAtLXJlZ2lvbiAiJFJFR0lPTiIKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ19tZXNzYWdlICJTZXJ2ZXIgc3RvcCBjb21tYW5kIGV4ZWN1dGVkIgogICAgICAgICAgICBleGl0IDAKICAgICAgICBmaQogICAgZWxzZQogICAgICAgICMgUmVzZXQgaWRsZSB0aW1lciB3aGVuIHBsYXllcnMgYXJlIG9ubGluZQogICAgICAgIGlmIFsgIiRpZGxlX3NlY29uZHMiIC1ndCAwIF07IHRoZW4KICAgICAgICAgICAgcGxheWVyX2xpc3Q9JChnZXRfcGxheWVyX2xpc3QpCiAgICAgICAgICAgIGxvZ19tZXNzYWdlICJQbGF5ZXJzIG9ubGluZS4gUmVzZXR0aW5nIGlkbGUgdGltZXIgKHBsYXllcnM6ICRwbGF5ZXJfbGlzdCkiCiAgICAgICAgZmkKICAgICAgICBpZGxlX3NlY29uZHM9MAogICAgZmkKICAgIAogICAgc2xlZXAgIiRDSEVDS19JTlRFUlZBTCIKZG9uZQo=' | base64 -d > /usr/local/bin/minecraft-autoshutdown.sh

# Set permissions
echo 'Setting permissions...'
chmod +x /usr/local/bin/minecraft-autoshutdown.sh

# Restart service
echo 'Restarting minecraft-autoshutdown service...'
systemctl start minecraft-autoshutdown.service

# Check status
echo ''
echo '=== Service Status ==='
systemctl status minecraft-autoshutdown.service --no-pager || true

# Show recent logs
echo ''
echo '=== Recent Logs (last 30 lines) ==='
tail -n 30 /var/log/minecraft-autoshutdown.log || echo 'Log file not found yet'

echo ''
echo '=== Update Complete ==='
echo 'New features:'
echo '  - Reads IDLE_TIME from SSM Parameter Store'
echo '  - Sends notifications to server-status channel via Discord Bot'
echo '  - Improved logging with instance ID and region'
