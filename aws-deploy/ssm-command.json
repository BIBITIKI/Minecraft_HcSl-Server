{
    "Comment":  "Update auto-shutdown script with SSM config reload support",
    "DocumentName":  "AWS-RunShellScript",
    "InstanceIds":  [
                        "i-0b3b312b21a19f71b"
                    ],
    "Parameters":  {
                       "commands":  [
                                        "#!/bin/bash\r\nset -e\r\n\r\necho \u0027=== Updating auto-shutdown script ===\u0027\r\n\r\n# Stop the service\r\necho \u0027Stopping minecraft-autoshutdown service...\u0027\r\nsystemctl stop minecraft-autoshutdown.service\r\n\r\n# Backup old script\r\necho \u0027Backing up old script...\u0027\r\nBACKUP_FILE=\"/usr/local/bin/minecraft-autoshutdown.sh.backup.$(date +%Y%m%d-%H%M%S)\"\r\ncp /usr/local/bin/minecraft-autoshutdown.sh \"$BACKUP_FILE\"\r\necho \"Backup saved to: $BACKUP_FILE\"\r\n\r\n# Write new script\r\necho \u0027Writing new script...\u0027\r\ncat \u003e /usr/local/bin/minecraft-autoshutdown.sh \u003c\u003c \u0027AUTOSHUTDOWN_SCRIPT_EOF\u0027\r\n#!/bin/bash\n\n# Auto-shutdown script for Minecraft server\n# Stops server after 15 minutes of no players\n\nLOG_FILE=\"/var/log/minecraft-autoshutdown.log\"\nMINECRAFT_LOG=\"/minecraft/server/logs/latest.log\"\nCHECK_INTERVAL=60  # Check every 1 minute\nDISCORD_WEBHOOK_URL=\"${DISCORD_WEBHOOK_URL:-}\"\n\n# Get instance metadata (once at startup)\nINSTANCE_ID=$(ec2-metadata --instance-id | cut -d \" \" -f 2)\nREGION=$(ec2-metadata --availability-zone | cut -d \" \" -f 2 | sed \u0027s/[a-z]$//\u0027)\n\n# Function to get IDLE_TIME from SSM Parameter Store\nget_idle_time() {\n    local idle_time=$(aws ssm get-parameter --name \"/minecraft/${INSTANCE_ID}/idle_time\" --region \"$REGION\" --query \u0027Parameter.Value\u0027 --output text 2\u003e/dev/null || echo \"900\")\n    \n    # Validate IDLE_TIME is a number\n    if ! [[ \"$idle_time\" =~ ^[0-9]+$ ]]; then\n        idle_time=900\n    fi\n    \n    echo \"$idle_time\"\n}\n\n# Initial IDLE_TIME\nIDLE_TIME=$(get_idle_time)\nLAST_CONFIG_CHECK=0\nCONFIG_CHECK_INTERVAL=300  # Check for config changes every 5 minutes (300 seconds)\n\n# Player tracking using associative array (bash 4.0+)\ndeclare -A players\n\nlog_message() {\n    echo \"[$(date \u0027+%Y-%m-%d %H:%M:%S\u0027)] $1\" \u003e\u003e \"$LOG_FILE\"\n}\n\n# Send Discord notification\nsend_discord_notification() {\n    local message=\"$1\"\n    \n    if [ -z \"$DISCORD_WEBHOOK_URL\" ]; then\n        log_message \"Discord webhook not configured, skipping notification\"\n        return\n    fi\n    \n    local json_payload=$(cat \u003c\u003cEOF\n{\n  \"content\": \"$message\"\n}\nEOF\n)\n    \n    curl -H \"Content-Type: application/json\" \\\n         -X POST \\\n         -d \"$json_payload\" \\\n         \"$DISCORD_WEBHOOK_URL\" 2\u003e\u00261 | tee -a \"$LOG_FILE\"\n}\n\n# Update player status from log\nupdate_player_status() {\n    if [ ! -f \"$MINECRAFT_LOG\" ]; then\n        return\n    fi\n    \n    # Process recent join/left events\n    while IFS= read -r line; do\n        # \"PlayerName joined the game\" pattern\n        if [[ \"$line\" =~ \\]:\\ ([^\\ ]+)\\ joined\\ the\\ game ]]; then\n            player=\"${BASH_REMATCH[1]}\"\n            players[\"$player\"]=1\n            log_message \"Player joined: $player\"\n        fi\n        \n        # \"PlayerName left the game\" pattern\n        if [[ \"$line\" =~ \\]:\\ ([^\\ ]+)\\ left\\ the\\ game ]]; then\n            player=\"${BASH_REMATCH[1]}\"\n            unset players[\"$player\"]\n            log_message \"Player left: $player\"\n        fi\n    done \u003c \u003c(tail -n 500 \"$MINECRAFT_LOG\" | grep -E \"(joined the game|left the game)\")\n}\n\n# Get current player count\nget_player_count() {\n    echo \"${#players[@]}\"\n}\n\n# Get current player list\nget_player_list() {\n    if [ \"${#players[@]}\" -eq 0 ]; then\n        echo \"none\"\n    else\n        echo \"${!players[@]}\"\n    fi\n}\n\nidle_seconds=0\nlast_player_count=0\n\nlog_message \"=========================================\"\nlog_message \"Auto-shutdown monitor started (improved version)\"\nlog_message \"Server will stop after ${IDLE_TIME} seconds ($(($IDLE_TIME / 60)) minutes) of no players\"\nlog_message \"Instance ID: $INSTANCE_ID, Region: $REGION\"\nlog_message \"=========================================\"\n\nwhile true; do\n    # Periodically check for config changes (every 5 minutes)\n    current_time=$(date +%s)\n    if [ $((current_time - LAST_CONFIG_CHECK)) -ge $CONFIG_CHECK_INTERVAL ]; then\n        NEW_IDLE_TIME=$(get_idle_time)\n        if [ \"$NEW_IDLE_TIME\" -ne \"$IDLE_TIME\" ]; then\n            log_message \"=========================================\"\n            log_message \"Config change detected: IDLE_TIME changed from ${IDLE_TIME}s ($(($IDLE_TIME / 60))min) to ${NEW_IDLE_TIME}s ($(($NEW_IDLE_TIME / 60))min)\"\n            log_message \"=========================================\"\n            IDLE_TIME=$NEW_IDLE_TIME\n            # Reset idle counter to apply new timeout\n            idle_seconds=0\n        fi\n        LAST_CONFIG_CHECK=$current_time\n    fi\n    \n    # Update player status\n    update_player_status\n    \n    player_count=$(get_player_count)\n    \n    # Log when player count changes\n    if [ \"$player_count\" -ne \"$last_player_count\" ]; then\n        player_list=$(get_player_list)\n        log_message \"Player count changed: $last_player_count -\u003e $player_count (current: $player_list)\"\n        last_player_count=$player_count\n    fi\n    \n    if [ \"$player_count\" -eq 0 ]; then\n        idle_seconds=$((idle_seconds + CHECK_INTERVAL))\n        \n        # Log status every 5 minutes\n        if [ $((idle_seconds % 300)) -eq 0 ]; then\n            remaining=$((IDLE_TIME - idle_seconds))\n            log_message \"No players for ${idle_seconds}s (stopping in ${remaining}s)\"\n        fi\n        \n        if [ \"$idle_seconds\" -ge \"$IDLE_TIME\" ]; then\n            log_message \"=========================================\"\n            log_message \"Stopping server after ${IDLE_TIME} seconds of no players\"\n            log_message \"=========================================\"\n            \n            # Send Discord notification via Lambda\n            current_time=$(date \u0027+%Y-%m-%d %H:%M:%S\u0027)\n            message=\"尅 **Minecraft繧ｵ繝ｼ繝舌・縺瑚・蜍募●豁｢縺励∪縺励◆**\\n\\n逅・罰: 繝励Ξ繧､繝､繝ｼ荳榊惠$(($IDLE_TIME / 60))蛻・ｵ碁℃\\n蛛懈ｭ｢譎ょ綾: $current_time\"\n            \n            # URL encode the message\n            encoded_message=$(echo -n \"$message\" | jq -sRr @uri)\n            \n            # Call Lambda function via API Gateway\n            REGION=$(ec2-metadata --availability-zone | cut -d \" \" -f 2 | sed \u0027s/[a-z]$//\u0027)\n            NOTIFY_URL=\"https://mf71h6a5f9.execute-api.${REGION}.amazonaws.com/prod/notify?message=${encoded_message}\u0026channel=status\"\n            \n            curl -s \"$NOTIFY_URL\" || log_message \"Failed to send Discord notification\"\n            \n            # Stop Minecraft server\n            systemctl stop minecraft.service\n            sleep 5\n            \n            # Stop EC2 instance\n            INSTANCE_ID=$(ec2-metadata --instance-id | cut -d \" \" -f 2)\n            \n            log_message \"Stopping EC2 instance: $INSTANCE_ID (region: $REGION)\"\n            aws ec2 stop-instances --instance-ids \"$INSTANCE_ID\" --region \"$REGION\"\n            \n            log_message \"Server stop command executed\"\n            exit 0\n        fi\n    else\n        # Reset idle timer when players are online\n        if [ \"$idle_seconds\" -gt 0 ]; then\n            player_list=$(get_player_list)\n            log_message \"Players online. Resetting idle timer (players: $player_list)\"\n        fi\n        idle_seconds=0\n    fi\n    \n    sleep \"$CHECK_INTERVAL\"\ndone\n\r\nAUTOSHUTDOWN_SCRIPT_EOF\r\n\r\n# Set permissions\r\necho \u0027Setting permissions...\u0027\r\nchmod +x /usr/local/bin/minecraft-autoshutdown.sh\r\n\r\n# Restart service\r\necho \u0027Restarting minecraft-autoshutdown service...\u0027\r\nsystemctl start minecraft-autoshutdown.service\r\n\r\n# Wait a moment for service to start\r\nsleep 2\r\n\r\n# Check status\r\necho \u0027\u0027\r\necho \u0027=== Service Status ===\u0027\r\nsystemctl status minecraft-autoshutdown.service --no-pager || true\r\n\r\n# Show recent logs\r\necho \u0027\u0027\r\necho \u0027=== Recent Logs (last 30 lines) ===\u0027\r\ntail -n 30 /var/log/minecraft-autoshutdown.log || echo \u0027Log file not found yet\u0027\r\n\r\necho \u0027\u0027\r\necho \u0027=== Update Complete ===\u0027\r\necho \u0027New features:\u0027\r\necho \u0027  - Reads IDLE_TIME from SSM Parameter Store\u0027\r\necho \u0027  - Checks for config changes every 5 minutes\u0027\r\necho \u0027  - Sends notifications to server-status channel via Discord Bot\u0027\r\necho \u0027  - Improved logging with instance ID and region\u0027"
                                    ]
                   }
}